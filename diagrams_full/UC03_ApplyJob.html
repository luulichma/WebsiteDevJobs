<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    <style>
        body {
            margin: 0;
            padding: 40px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .mermaid {
            background: white;
        }
    </style>
</head>
<body>
    <div class="mermaid">
sequenceDiagram
    actor Candidate as ğŸ‘¤ á»¨ng viÃªn<br/>(Candidate)
    participant UI as ğŸ–¥ï¸ Giao diá»‡n<br/>(Job Detail Page)
    participant Server as âš™ï¸ Server<br/>(Backend)
    participant Storage as â˜ï¸ Cloud Storage<br/>(Cloudinary/S3)
    participant DB as ğŸ’¾ Database

    Note over Candidate,DB: UC03: á»¨ng tuyá»ƒn cÃ´ng viá»‡c

    %% Main Flow: Apply Job
    rect rgb(230, 245, 255)
        Note over Candidate,DB: Luá»“ng chÃ­nh: Ná»™p há»“ sÆ¡
        Candidate->>UI: 1. Xem trang chi tiáº¿t Job
        UI-->>Candidate: 2. Hiá»ƒn thá»‹ thÃ´ng tin Job
        Candidate->>UI: 3. Nháº¥n "Apply Now"
        UI-->>Candidate: 4. Hiá»ƒn thá»‹ Form ná»™p há»“ sÆ¡
        
        Candidate->>UI: 5. Táº£i file CV (PDF)
        Candidate->>UI: 6. Viáº¿t Cover Letter
        Candidate->>UI: 7. Nháº¥n "Ná»™p há»“ sÆ¡"
        
        UI->>Server: 8. POST /api/applications<br/>{job_id, cv_file, cover_letter}
        
        %% File validation
        Server->>Server: 9. Validate file<br/>(format=PDF?, size<5MB?)
        
        alt File khÃ´ng há»£p lá»‡ (E1)
            Server-->>UI: 10a. Error: File invalid
            UI-->>Candidate: 11a. "Chá»‰ cháº¥p nháº­n PDF <5MB"
        else File há»£p lá»‡
            %% Check duplicate
            Server->>DB: 10b. SELECT FROM Applications<br/>WHERE job_id=? AND candidate_id=?
            
            alt ÄÃ£ ná»™p Ä‘Æ¡n (E3)
                DB-->>Server: 11c. ÄÃ£ tá»“n táº¡i record
                Server-->>UI: 12c. Error: Already applied
                UI-->>Candidate: 13c. "Báº¡n Ä‘Ã£ ná»™p há»“ sÆ¡"
            else ChÆ°a ná»™p
                DB-->>Server: 11d. KhÃ´ng tá»“n táº¡i
                
                %% Upload to cloud
                Server->>Storage: 12d. Upload CV file
                Storage-->>Server: 13d. Tráº£ vá» cv_url
                
                %% Save to DB
                Server->>DB: 14d. INSERT Applications<br/>(job_id, candidate_id, cv_url,<br/>cover_letter, status='pending')
                DB-->>Server: 15d. Success
                
                Server-->>UI: 16d. Success response
                UI-->>Candidate: 17d. âœ… "Ná»™p há»“ sÆ¡ thÃ nh cÃ´ng!"
            end
        end
    end

    %% Alternative Flow: Update Application
    rect rgb(255, 250, 230)
        Note over Candidate,DB: Luá»“ng thay tháº¿ A1: Cáº­p nháº­t há»“ sÆ¡
        
        Candidate->>UI: 18. VÃ o láº¡i trang Job Ä‘Ã£ á»©ng tuyá»ƒn
        UI->>Server: 19. GET /api/applications/status?job_id=...
        Server->>DB: 20. SELECT status FROM Applications
        DB-->>Server: 21. Tráº£ vá» status hiá»‡n táº¡i
        
        alt Status Ä‘ang xá»­ lÃ½ (E2)
            Note over Server: status IN ('viewed','shortlisted',<br/>'interview','accepted','rejected')
            Server-->>UI: 22a. Status = processing
            UI-->>Candidate: 23a. Hiá»ƒn thá»‹ "ÄÃ£ á»©ng tuyá»ƒn"<br/>âš ï¸ áº¨n nÃºt "Cáº­p nháº­t"<br/>"Há»“ sÆ¡ Ä‘ang Ä‘Æ°á»£c xem xÃ©t"
        else Status = pending
            Server-->>UI: 22b. Status = pending
            UI-->>Candidate: 23b. Hiá»ƒn thá»‹ "ÄÃ£ á»©ng tuyá»ƒn"<br/>âœï¸ NÃºt "Cáº­p nháº­t há»“ sÆ¡"
            
            Candidate->>UI: 24. Nháº¥n "Cáº­p nháº­t há»“ sÆ¡"
            UI-->>Candidate: 25. Hiá»ƒn thá»‹ Form cáº­p nháº­t
            
            Candidate->>UI: 26. Táº£i CV má»›i (PDF)
            Candidate->>UI: 27. Sá»­a Cover Letter
            Candidate->>UI: 28. Nháº¥n "LÆ°u thay Ä‘á»•i"
            
            UI->>Server: 29. PUT /api/applications/{id}<br/>{cv_file_new, cover_letter_new}
            
            %% Validate new file
            Server->>Server: 30. Validate file má»›i
            
            alt File khÃ´ng há»£p lá»‡
                Server-->>UI: 31a. Error
                UI-->>Candidate: 32a. "File khÃ´ng há»£p lá»‡"
            else File há»£p lá»‡
                %% Upload new CV
                Server->>Storage: 31b. Upload CV má»›i
                Storage-->>Server: 32b. cv_url_new
                
                %% Delete old CV
                Server->>Storage: 33b. Delete CV cÅ©
                Storage-->>Server: 34b. Deleted
                
                %% Update DB
                Server->>DB: 35b. UPDATE Applications<br/>SET cv_url=cv_url_new,<br/>cover_letter=...,<br/>applied_at=NOW()
                DB-->>Server: 36b. Updated
                
                Server-->>UI: 37b. Success
                UI-->>Candidate: 38b. âœ… "Cáº­p nháº­t thÃ nh cÃ´ng!"
            end
        end
    end

    </div>
</body>
</html>