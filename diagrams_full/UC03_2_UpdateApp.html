<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    <style>
        body {
            margin: 0;
            padding: 40px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .mermaid {
            background: white;
        }
    </style>
</head>
<body>
    <div class="mermaid">
sequenceDiagram
    actor Candidate as ğŸ‘¤ á»¨ng viÃªn<br/>(Candidate)
    participant UI as ğŸ–¥ï¸ Giao diá»‡n<br/>(Job Detail Page)
    participant Server as âš™ï¸ Server<br/>(Backend)
    participant Storage as â˜ï¸ Cloud Storage<br/>(Cloudinary/S3)
    participant DB as ğŸ’¾ Database

    Note over Candidate,DB: UC03: Cáº­p nháº­t há»“ sÆ¡ á»©ng tuyá»ƒn

    Candidate->>UI: 1. VÃ o láº¡i trang Job Ä‘Ã£ á»©ng tuyá»ƒn
    UI->>Server: 2. GET /api/applications/status?job_id=...
    Server->>DB: 3. SELECT status FROM Applications<br/>WHERE job_id=? AND candidate_id=?
    DB-->>Server: 4. Tráº£ vá» status hiá»‡n táº¡i
    
    alt E2: Status Ä‘ang xá»­ lÃ½
        Note over Server: status IN ('viewed','shortlisted',<br/>'interview','accepted','rejected')
        Server-->>UI: 5a. Status = processing
        UI-->>Candidate: 6a. Hiá»ƒn thá»‹ "ÄÃ£ á»©ng tuyá»ƒn"<br/>ğŸ”’ áº¨n nÃºt "Cáº­p nháº­t"<br/>âš ï¸ "Há»“ sÆ¡ Ä‘ang Ä‘Æ°á»£c NhÃ  tuyá»ƒn dá»¥ng xem xÃ©t"
    else Status = pending - OK
        Server-->>UI: 5b. Status = pending
        UI-->>Candidate: 6b. Hiá»ƒn thá»‹ "ÄÃ£ á»©ng tuyá»ƒn"<br/>âœï¸ NÃºt "Cáº­p nháº­t há»“ sÆ¡"
        
        Candidate->>UI: 7. Nháº¥n "Cáº­p nháº­t há»“ sÆ¡"
        UI-->>Candidate: 8. Hiá»ƒn thá»‹ Form cáº­p nháº­t<br/>(CV cÅ© + Cover Letter cÅ©)
        
        Candidate->>UI: 9. Táº£i CV má»›i (PDF)
        Candidate->>UI: 10. Sá»­a Cover Letter
        Candidate->>UI: 11. Nháº¥n "LÆ°u thay Ä‘á»•i"
        
        UI->>Server: 12. PUT /api/applications/{id}<br/>{cv_file_new, cover_letter_new}
        
        %% Validate new file
        Server->>Server: 13. Validate file má»›i<br/>(PDF?, <5MB?)
        
        alt File khÃ´ng há»£p lá»‡
            Server-->>UI: 14a. Error: Invalid file
            UI-->>Candidate: 15a. âŒ "File khÃ´ng há»£p lá»‡"
        else File há»£p lá»‡
            %% Upload new CV
            Server->>Storage: 14b. Upload CV má»›i
            Storage-->>Server: 15b. Tráº£ vá» cv_url_new
            
            %% Delete old CV from cloud
            Server->>Storage: 16b. Delete CV cÅ©
            Storage-->>Server: 17b. Deleted
            
            %% Update DB
            Server->>DB: 18b. UPDATE Applications<br/>SET cv_url=cv_url_new,<br/>cover_letter=new_letter,<br/>applied_at=NOW()<br/>WHERE application_id=?
            DB-->>Server: 19b. Updated
            
            Server-->>UI: 20b. Success response
            UI-->>Candidate: 21b. âœ… "Cáº­p nháº­t há»“ sÆ¡ thÃ nh cÃ´ng!"
        end
    end

    </div>
</body>
</html>