<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    <style>
        body {
            margin: 0;
            padding: 40px;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .mermaid {
            background: white;
        }
    </style>
</head>
<body>
    <div class="mermaid">
sequenceDiagram
    actor Admin as ‚öôÔ∏è Qu·∫£n tr·ªã vi√™n<br/>(Admin)
    participant UI as üñ•Ô∏è Giao di·ªán<br/>(Admin Dashboard)
    participant Server as ‚öôÔ∏è Server<br/>(Backend)
    participant DB as üíæ Database
    participant Email as üìß Email Service
    participant Log as üìù Admin Logs

    Note over Admin,Log: UC10: Qu·∫£n l√Ω ng∆∞·ªùi d√πng

    %% Xem danh s√°ch users
    Admin->>UI: 1. Truy c·∫≠p "Qu·∫£n l√Ω ng∆∞·ªùi d√πng"
    UI->>Server: 2. GET /api/admin/users?page=1&limit=50
    Server->>DB: 3. SELECT u.id, u.full_name, u.email,<br/>u.role, u.status, u.created_at,<br/>COUNT(applications) as activity_count<br/>FROM Users u<br/>LEFT JOIN Applications/Jobs<br/>GROUP BY u.id<br/>LIMIT 50 OFFSET 0
    DB-->>Server: 4. Tr·∫£ v·ªÅ danh s√°ch users
    Server-->>UI: 5. Tr·∫£ v·ªÅ d·ªØ li·ªáu users
    UI-->>Admin: 6. Hi·ªÉn th·ªã b·∫£ng danh s√°ch<br/>(ID, Name, Email, Role, Status,<br/>Created, Last Login, Activity, Actions)

    %% T√¨m ki·∫øm v√† l·ªçc
    rect rgb(240, 248, 255)
        Note over Admin,Log: Alternative Flow: T√¨m ki·∫øm/L·ªçc
        Admin->>UI: A1. Nh·∫≠p t·ª´ kh√≥a ho·∫∑c ch·ªçn b·ªô l·ªçc<br/>(Role, Status, Date range)
        UI->>Server: A2. GET /api/admin/users?search=...&role=...&status=...
        Server->>DB: A3. SELECT v·ªõi ƒëi·ªÅu ki·ªán WHERE
        DB-->>Server: A4. K·∫øt qu·∫£ ph√π h·ª£p
        Server-->>UI: A5. Tr·∫£ v·ªÅ
        UI-->>Admin: A6. Hi·ªÉn th·ªã [N] k·∫øt qu·∫£
    end

    %% Xem chi ti·∫øt user
    Admin->>UI: 7. Nh·∫•n "View Details" tr√™n 1 user
    UI->>Server: 8. GET /api/admin/users/:id
    Server->>DB: 9. SELECT u.*, c.company_name,<br/>login_history, activity_logs<br/>FROM Users u<br/>LEFT JOIN Companies c<br/>WHERE u.id = ?
    DB-->>Server: 10. Th√¥ng tin chi ti·∫øt user
    Server-->>UI: 11. Tr·∫£ v·ªÅ data
    UI-->>Admin: 12. Modal hi·ªÉn th·ªã chi ti·∫øt<br/>(Info, CV/Jobs, Login history)

    %% T·∫°m kh√≥a t√†i kho·∫£n
    rect rgb(255, 240, 240)
        Note over Admin,Log: Alternative Flow: T·∫°m kh√≥a (Suspend)
        Admin->>UI: S1. Nh·∫•n "Suspend" tr√™n user Active
        UI-->>Admin: S2. H·ªôp tho·∫°i ch·ªçn l√Ω do kh√≥a<br/>(Vi ph·∫°m, Spam, Gian l·∫≠n...)
        Admin->>UI: S3. Ch·ªçn l√Ω do v√† nh·∫•n "X√°c nh·∫≠n"
        
        UI->>Server: S4. PUT /api/admin/users/:id/suspend<br/>(reason, notes)
        
        Server->>DB: S5. UPDATE Users<br/>SET status = 'Suspended',<br/>suspended_at = NOW(),<br/>suspend_reason = ?<br/>WHERE id = ?
        DB-->>Server: S6. X√°c nh·∫≠n c·∫≠p nh·∫≠t
        
        Server->>Log: S7. INSERT INTO AdminLogs<br/>(admin_id, action='SUSPEND_USER',<br/>target_user_id, reason, ip_address)
        Log-->>Server: S8. Log ƒë√£ l∆∞u
        
        Server->>Email: S9. G·ª≠i email th√¥ng b√°o<br/>"T√†i kho·∫£n b·ªã kh√≥a v√¨ [reason]"
        Email-->>Server: S10. Email sent
        
        Server-->>UI: S11. Success
        UI-->>Admin: S12. ‚úÖ "ƒê√£ kh√≥a t√†i kho·∫£n [email]"
    end

    %% M·ªü kh√≥a t√†i kho·∫£n
    rect rgb(240, 255, 240)
        Note over Admin,Log: Alternative Flow: M·ªü kh√≥a (Activate)
        Admin->>UI: U1. Nh·∫•n "Activate" tr√™n user Suspended
        UI-->>Admin: U2. Hi·ªÉn th·ªã l√Ω do kh√≥a tr∆∞·ªõc ƒë√≥<br/>"X√°c nh·∫≠n m·ªü kh√≥a?"
        Admin->>UI: U3. Nh·∫•n "X√°c nh·∫≠n"
        
        UI->>Server: U4. PUT /api/admin/users/:id/activate
        
        Server->>DB: U5. UPDATE Users<br/>SET status = 'Active',<br/>suspended_at = NULL,<br/>suspend_reason = NULL
        DB-->>Server: U6. X√°c nh·∫≠n
        
        Server->>Log: U7. Log action 'ACTIVATE_USER'
        Server->>Email: U8. "T√†i kho·∫£n ƒë√£ m·ªü kh√≥a"
        
        Server-->>UI: U9. Success
        UI-->>Admin: U10. ‚úÖ "ƒê√£ m·ªü kh√≥a t√†i kho·∫£n"
    end

    %% X√≥a user
    rect rgb(255, 245, 240)
        Note over Admin,Log: Alternative Flow: X√≥a user (Delete)
        Admin->>UI: D1. Nh·∫•n "Delete"
        UI->>Server: D2. GET /api/admin/users/:id/check-activity
        
        Server->>DB: D3. SELECT COUNT(*) as activity<br/>FROM Applications/Jobs<br/>WHERE user_id = ?
        DB-->>Server: D4. activity_count
        
        alt C√≥ ho·∫°t ƒë·ªông (activity > 0)
            Server-->>UI: D5. ‚ùå Kh√¥ng cho ph√©p x√≥a
            UI-->>Admin: "Kh√¥ng th·ªÉ x√≥a user c√≥ ho·∫°t ƒë·ªông.<br/>ƒê·ªÅ xu·∫•t: T·∫°m kh√≥a"
        else Kh√¥ng c√≥ ho·∫°t ƒë·ªông
            UI-->>Admin: D6. ‚ö†Ô∏è "C·∫¢NH B√ÅO: Kh√¥ng th·ªÉ ho√†n t√°c!<br/>Nh·∫≠p email ƒë·ªÉ x√°c nh·∫≠n"
            Admin->>UI: D7. Nh·∫≠p email ch√≠nh x√°c
            UI->>Server: D8. DELETE /api/admin/users/:id
            
            Server->>DB: D9. UPDATE Users<br/>SET status = 'Deleted',<br/>deleted_at = NOW(),<br/>email = CONCAT('deleted_', id, '_', email)
            DB-->>Server: D10. X√°c nh·∫≠n
            
            Server->>Log: D11. INSERT critical log<br/>'DELETE_USER' with full details
            Log-->>Server: D12. Log saved
            
            Server-->>UI: D13. Success
            UI-->>Admin: D14. ‚úÖ "ƒê√£ x√≥a user"
        end
    end

    %% Ch·ªânh s·ª≠a th√¥ng tin
    rect rgb(250, 250, 255)
        Note over Admin,Log: Alternative Flow: Ch·ªânh s·ª≠a user
        Admin->>UI: E1. Nh·∫•n "Edit"
        UI-->>Admin: E2. Form ch·ªânh s·ª≠a (pre-fill data)
        Admin->>UI: E3. S·ª≠a name/email/phone/role/status
        Admin->>UI: E4. Nh·∫•n "L∆∞u"
        
        UI->>Server: E5. PUT /api/admin/users/:id<br/>(updated data)
        
        Server->>Server: E6. Validate<br/>(Email unique, Phone valid, Name not empty)
        
        alt Validation OK
            Server->>DB: E7. UPDATE Users<br/>SET full_name=?, email=?, phone=?,<br/>role=?, status=?
            DB-->>Server: E8. X√°c nh·∫≠n
            Server->>Log: E9. Log 'UPDATE_USER'
            Server->>Email: E10. Th√¥ng b√°o user (n·∫øu c·∫ßn)
            Server-->>UI: E11. Success
            UI-->>Admin: E12. ‚úÖ "C·∫≠p nh·∫≠t th√†nh c√¥ng"
        else Email ƒë√£ t·ªìn t·∫°i
            Server-->>UI: ‚ùå "Email ƒë√£ ƒë∆∞·ª£c d√πng"
            UI-->>Admin: Hi·ªÉn th·ªã l·ªói validation
        end
    end

    Note over Admin,Log: K·∫øt th√∫c use case<br/>(M·ªçi h√†nh ƒë·ªông ƒë·ªÅu ƒë∆∞·ª£c log)

    </div>
</body>
</html>